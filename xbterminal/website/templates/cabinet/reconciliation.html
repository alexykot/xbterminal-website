{% extends "cabinet/base.html" %}
{% load bootstrap bootstrap3 staticfiles website_tags %}


{% block cabinet_nav %}
{% include 'cabinet/inclusions/nav.html' with DEVICES_ACTIVE='True' %}
{% endblock %}

{% block cabinet_content %}
<h3>{{ device.name }}</h3>

<div class="form-title">send daily reconciliation to email every day at</div>
<form action="{% url 'website:reconciliation_time' device.key 0 %}" method="POST" class="rectime-add">
    {% csrf_token %}
    <div class="row">
        <div class="col-sm-4">
            {% bootstrap_field form.email show_label='' %}
        </div>
        <div class="col-sm-4">
            {% bootstrap_field form.time show_label='' %}
        </div>
        <div class="col-sm-4">
            <button type="submit" class="btn btn-default">Add</button>
        </div>
    </div>
</form>

<table class="table table-striped table-bordered table-responsive">
    <tr>
        <th>email</th>
        <th colspan="2">time</th>
    </tr>
    {% for rectime in reconciliation_schedule %}
    <tr>
        <td>{{ rectime.email }}</td>
        <td>{{ rectime.time }}</td>
        <td><a href="{% url 'website:reconciliation_time' device.key rectime.pk %}" class="rectime-remove">remove</a></td>
    </tr>
    {% endfor %}
</table>

<div class="form-title">
    daily reconciliation history
    <a href="{% url 'website:transactions' device.key %}" class="pull-right">download all transactions</a>
    <a href="{% url 'website:receipts' device.key %}" style="clear:both;" class="pull-right">download all receipts</a>
</div>
<table class="table table-striped table-bordered table-responsive">
    <tr>
        <td>date</td>
        <td>total transactions</td>
        <td>total amount</td>
        <td>total converted</td>
        <td></td>
    </tr>
    {% for info in daily_transaction_info %}
    <tr>
        <td>{{ info.date|date:"d N Y" }}</td>
        <td>{{ info.count }}</td>
        <td>mà¸¿ {{ info.btc_amount|scale|floatformat:2 }} / {{ info.fiat_currency }} {{ info.fiat_amount|floatformat:2 }}</td>
        <td>{{ info.instantfiat_fiat_amount }}</td>
        <td>
            {% with info.date as date %}
            <a href="{% url 'website:dated_transactions' device_key=device.key year=date|date:"Y" month=date|date:"m" day=date|date:"d" %}">download transactions</a>
            <br>
            <a href="{% url 'website:dated_receipts' device_key=device.key year=date|date:"Y" month=date|date:"m" day=date|date:"d" %}">download receipts</a>
            <br>
            <a href="" class="send-all-button" data-date="{{ date|date:'Y-m-d' }}">send all to email</a>
            {% endwith %}
        </td>
    </tr>
    {% empty %}
    <tr><td>empty</td></tr>
    {% endfor %}
</table>
<div id="modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Send all to email</h4>
      </div>
      <form action="{% url 'website:send_all_to_email' device.key %}" method="post">
          <div class="modal-body">
                {% csrf_token %}
                {{ send_form|bootstrap }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Send</button>
          </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{% endblock %}

{% block js %}
{{ form.media }}
<script>
$(document).ready(function(){
    $('.send-all-button').click(function(e){
        e.preventDefault();

        var date = $(this).attr('data-date');
        $('#modal input[name=date]').val(date);
        $('#modal').modal();

    });
    $(document).on('click', '.rectime-remove', function (event) {
        event.preventDefault();
        var button = $(this);
        var token = $('.rectime-add [name="csrfmiddlewaretoken"]').val();
        $.ajax({
            url: button.attr('href'),
            method: 'DELETE',
            headers: {
                'X-CSRFToken': token
            }
        }).done(function (data) {
            button.closest('tr').remove();
        });
    });
})
</script>
{% endblock %}
